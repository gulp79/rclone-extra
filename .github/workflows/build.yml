# Github Actions build for rclone (Custom & Clean)
# Features:
# - Windows: CGO enabled (cmount), Static Linking (no DLL deps), Custom Icon
# - Linux:   CGO disabled (Pure Go), Static Linking, Multi-arch
# - Android: All architectures (Pure Go, no CGO)

name: Build rclone-extra - Multi Platform

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Seleziona cosa compilare"
        type: choice
        required: true
        default: all
        options:
          - all
          - linux
          - windows
          - android
  push:
    tags:
      - 'v*'

permissions:
  contents: read

jobs:

  # --- JOB: DESKTOP & SERVER (Linux x64, Linux ARM64, Windows x64) ---
  build:
    name: Build ${{ matrix.name }}
    runs-on: ubuntu-latest
    timeout-minutes: 45

    # Esegue solo se la scelta è 'all' oppure corrisponde all'OS della matrice
    if: |
      inputs.target == 'all' ||
      (inputs.target == 'linux')   ||
      (inputs.target == 'windows')

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-amd64
            goos: linux
            goarch: amd64
            ext: ''
          - name: linux-arm64
            goos: linux
            goarch: arm64
            ext: ''
          - name: linux-arm-v7
            goos: linux
            goarch: arm
            goarm: 7
            ext: ''
          - name: windows-amd64
            goos: windows
            goarch: amd64
            ext: '.exe'

    steps:
      - name: Skip non matching matrix rows
        id: gate
        run: |
          TARGET="${{ inputs.target }}"
          GOOS="${{ matrix.goos }}"
          if [ "$TARGET" = "linux" ] && [ "$GOOS" != "linux" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          elif [ "$TARGET" = "windows" ] && [ "$GOOS" != "windows" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.gate.outputs.skip == 'false'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Go
        if: steps.gate.outputs.skip == 'false'
        uses: actions/setup-go@v6
        with:
          go-version: '1.26.x'
          check-latest: true
          cache: true

      # --- WINDOWS PRE-REQUISITES ---
      - name: Install MinGW (Windows Only)
        if: steps.gate.outputs.skip == 'false' && matrix.goos == 'windows'
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64

      - name: Setup WinFsp Headers (Windows Only)
        if: steps.gate.outputs.skip == 'false' && matrix.goos == 'windows'
        run: |
          wget -q -O winfsp.zip https://github.com/winfsp/winfsp/archive/refs/tags/v2.1.zip
          unzip -q winfsp.zip
          echo "WINFSP_INC=$(pwd)/winfsp-2.1/inc/fuse" >> $GITHUB_ENV

      - name: Setup Icon (Windows Only)
        if: steps.gate.outputs.skip == 'false' && matrix.goos == 'windows'
        run: |
          go install github.com/akavel/rsrc@latest
          curl -L https://raw.githubusercontent.com/rclone/rclone/master/graphics/logo/ico/logo_symbol_color.ico -o rclone.ico
          rsrc -ico rclone.ico -o rclone.syso

      # --- BUILD STEP ---
      - name: Build Rclone (${{ matrix.name }})
        if: steps.gate.outputs.skip == 'false'
        shell: bash
        run: |
          # Setup Variabili
          export GOOS=${{ matrix.goos }}
          export GOARCH=${{ matrix.goarch }}
          VERSION=$(echo "v1.73.1-extra")

          # Flag base: strip debug (-s -w) e versione
          LDFLAGS_BASE="-s -w -buildid= -X github.com/rclone/rclone/fs.Version=${VERSION}"

          # --- Logica specifica OS ---
          if [ "$GOOS" == "windows" ]; then
            echo "::group::Configuring Windows STATIC Build"
            export CGO_ENABLED=1
            export CC=x86_64-w64-mingw32-gcc
            export CXX=x86_64-w64-mingw32-g++
            export CGO_CFLAGS="-I$WINFSP_INC"
            export CGO_LDFLAGS="-static"
            LDFLAGS="$LDFLAGS_BASE -extldflags '-static -static-libgcc -static-libstdc++'"
            TAGS="-tags cmount"
            echo "::endgroup::"
          else
            echo "::group::Configuring Linux Pure-Static Build"
            export CGO_ENABLED=0
            TAGS="-tags netgo,osusergo"
            LDFLAGS="$LDFLAGS_BASE"
            echo "::endgroup::"
          fi

          echo "Building for $GOOS/$GOARCH..."
          go build -v -trimpath -mod=readonly -ldflags "$LDFLAGS" $TAGS -o rclone${{ matrix.ext }} .

      - name: Upload Artifact
        if: steps.gate.outputs.skip == 'false'
        uses: actions/upload-artifact@v6
        with:
          name: rclone-${{ matrix.name }}
          path: rclone${{ matrix.ext }}
          if-no-files-found: error

# --- JOB: ANDROID ---
  android:
    name: Build Android
    runs-on: ubuntu-latest
    timeout-minutes: 30

    if: inputs.target == 'all' || inputs.target == 'android'

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.x'
          check-latest: true
          cache: true

      - name: Build Android Targets
        run: |
          set -euo pipefail
          VERSION=$(echo "v1.72.1-android-extra")
          FLAGS="-s -w -buildid= -X github.com/rclone/rclone/fs.Version=${VERSION}"
          
          mkdir -p build build-logs
          
          # --- CONFIGURAZIONE NDK (Necessaria per arm 32-bit) ---
          # GitHub Actions Ubuntu include l'NDK. Lo usiamo per CGO.
          NDK_ROOT="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          API="23" 

          for ARCH in arm arm64 386 amd64; do
            echo "::group::Building for android/$ARCH"
            
            # Setup variabili specifiche
            export GOOS=android
            export GOARCH=$ARCH
            export CGO_ENABLED=1  # Necessario per arm, lo usiamo per tutti per coerenza
            
            # Seleziona il compilatore C (Clang) corretto dall'NDK
            if [ "$ARCH" == "arm" ]; then
              CC_BIN="$NDK_ROOT/armv7a-linux-androideabi${API}-clang"
            elif [ "$ARCH" == "arm64" ]; then
              CC_BIN="$NDK_ROOT/aarch64-linux-android${API}-clang"
            elif [ "$ARCH" == "386" ]; then
              CC_BIN="$NDK_ROOT/i686-linux-android${API}-clang"
            elif [ "$ARCH" == "amd64" ]; then
              CC_BIN="$NDK_ROOT/x86_64-linux-android${API}-clang"
            fi
            
            # Imposta il compilatore per CGO
            export CC="$CC_BIN"

            echo "Using compiler: $CC"

            # Compilazione
            go build -v -trimpath -mod=readonly -ldflags "$FLAGS" \
              -o build/rclone-android-$ARCH . 2>&1 | tee "build-logs/build-android-$ARCH.log"
            
            if [ -f "build/rclone-android-$ARCH" ]; then
              echo "✅ Successfully built rclone-android-$ARCH"
              ls -lh build/rclone-android-$ARCH
            else
              echo "❌ Failed to build rclone-android-$ARCH"
              exit 1
            fi
            echo "::endgroup::"
          done

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: rclone-android-all
          path: build/rclone-android-*
          if-no-files-found: error
          
      - name: Upload Android build logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: logs-android
          path: build-logs/build-android-*.log
