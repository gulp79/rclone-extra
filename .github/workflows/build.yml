# Github Actions build for rclone (Custom & Clean)
# Fixes: Windows Mount (Missing fuse_common.h), Linux Cross-Compile
name: build

on:
  workflow_dispatch:
    inputs:
      manual:
        description: Manual run
        type: boolean
        default: true

jobs:
  # -------------------------------------------------------------------------
  # JOB 1: DESKTOP & SERVER (Linux x64, Linux ARM64, Windows x64)
  # -------------------------------------------------------------------------
  build:
    timeout-minutes: 60
    name: Build ${{ matrix.name }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- LINUX X64 ---
          - name: linux-amd64
            goos: linux
            goarch: amd64
            ext: ''
            
          # --- LINUX ARM64 ---
          - name: linux-arm64
            goos: linux
            goarch: arm64
            ext: ''

          # --- WINDOWS X64 (Richiede CGO + Headers WinFsp) ---
          - name: windows-amd64
            goos: windows
            goarch: amd64
            ext: '.exe'

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version: '>=1.24'
          check-latest: true

      # --- Installazione Compilatori per CGO (Necessario per Windows) ---
      - name: Install Cross-Compilers
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64

      # --- STEP AGGIUNTO: Scarica Headers WinFsp per Windows ---
      # Senza questo, MinGW non trova fuse_common.h e la build fallisce
      - name: Setup WinFsp Headers (Windows Only)
        if: matrix.goos == 'windows'
        run: |
          echo "Downloading WinFsp headers..."
          # Scarichiamo il codice sorgente di WinFsp (versione stabile)
          wget -q https://github.com/winfsp/winfsp/archive/refs/tags/v2.0.zip -O winfsp.zip
          unzip -q winfsp.zip
          
          # Salviamo il percorso degli header in una variabile ambiente per il prossimo step
          # Nota: puntiamo a 'inc/fuse' perché rclone si aspetta di trovare fuse_common.h nella root dell'include
          echo "WINFSP_INC=$(pwd)/winfsp-2.0/inc/fuse" >> $GITHUB_ENV
          
      # --- STEP PER L'ICONA WINDOWS ---
      - name: Install rsrc tool (Windows Only)
        if: matrix.goos == 'windows'
        run: go install github.com/akavel/rsrc@latest

      - name: Download Official Icon (Windows Only)
        if: matrix.goos == 'windows'
        run: curl -L https://raw.githubusercontent.com/rclone/rclone/master/graphics/logo/ico/logo_symbol_color.ico -o rclone.ico

      - name: Generate Resource .syso (Windows Only)
        if: matrix.goos == 'windows'
        run: rsrc -ico rclone.ico -o rclone.syso

      - name: Build Rclone (${{ matrix.name }})
        shell: bash
        run: |
          # Variabili Base
          export GOOS=${{ matrix.goos }}
          export GOARCH=${{ matrix.goarch }}
          
          # Calcoliamo la versione
          VERSION="v1.72.0-extra"
          LDFLAGS="-s -w -X github.com/rclone/rclone/fs.Version=${VERSION}"
          
          # --- LOGICA DI CONFIGURAZIONE COMPILATORE ---
          
          if [ "$GOOS" == "windows" ]; then
            echo "Configuring Build for WINDOWS (CGO Enabled for cmount)..."
            
            export CGO_ENABLED=1
            export CC=x86_64-w64-mingw32-gcc
            export CXX=x86_64-w64-mingw32-g++
            
            # --- PUNTO CRUCIALE: Diciamo a CGO dove trovare fuse_common.h ---
            # Usiamo la variabile impostata nello step precedente
            export CGO_CFLAGS="-I$WINFSP_INC"
            
            TAGS="-tags cmount"
            
          elif [ "$GOOS" == "linux" ]; then
            echo "Configuring Build for LINUX (Static)..."
            # CGO OFF per Linux garantisce compatibilità e risolve problemi ARM64
            export CGO_ENABLED=0
            TAGS="" 
          fi
          
          echo "Building for $GOOS/$GOARCH..."
          echo "CGO_ENABLED: $CGO_ENABLED"
          echo "CC: $CC"
          echo "CGO_CFLAGS: $CGO_CFLAGS"
          
          # Esecuzione Build
          go build -v -trimpath -ldflags "$LDFLAGS" $TAGS -o rclone${{ matrix.ext }} .

      - name: Check Version (Solo se compatibile con runner)
        if: matrix.goarch == 'amd64' && matrix.goos == 'linux'
        run: ./rclone version

      - name: Upload Artifact (${{ matrix.name }})
        uses: actions/upload-artifact@v4
        with:
          name: rclone-${{ matrix.name }}
          path: rclone${{ matrix.ext }}

  # -------------------------------------------------------------------------
  # JOB 2: ANDROID (Invariato)
  # -------------------------------------------------------------------------
  android:
    timeout-minutes: 30
    name: Build Android
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.24'

      - name: Set global environment variables
        run: |
          echo "VERSION=$(make version)" >> $GITHUB_ENV

      - name: Install Gomobile tools
        run: |
          go install golang.org/x/mobile/cmd/gobind@latest
          go install golang.org/x/mobile/cmd/gomobile@latest
          env PATH=$PATH:~/go/bin gomobile init
          echo "RCLONE_NDK_VERSION=21" >> $GITHUB_ENV

      - name: Build Android ARMv7a
        run: |
          export CC=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi${RCLONE_NDK_VERSION}-clang
          export CC_FOR_TARGET=$CC
          export GOOS=android
          export GOARCH=arm
          export GOARM=7
          export CGO_ENABLED=1
          export CGO_LDFLAGS="-fuse-ld=lld -s -w"
          go build -v -tags android -trimpath -ldflags "-s -X github.com/rclone/rclone/fs.Version=${VERSION}" -o build/rclone-android-${RCLONE_NDK_VERSION}-armv7a .

      - name: Build Android ARM64
        run: |
          export CC=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${RCLONE_NDK_VERSION}-clang
          export CC_FOR_TARGET=$CC
          export GOOS=android
          export GOARCH=arm64
          export CGO_ENABLED=1
          export CGO_LDFLAGS="-fuse-ld=lld -s -w"
          go build -v -tags android -trimpath -ldflags "-s -X github.com/rclone/rclone/fs.Version=${VERSION}" -o build/rclone-android-${RCLONE_NDK_VERSION}-armv8a .

      - name: Build Android x86
        run: |
          export CC=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android${RCLONE_NDK_VERSION}-clang
          export CC_FOR_TARGET=$CC
          export GOOS=android
          export GOARCH=386
          export CGO_ENABLED=1
          export CGO_LDFLAGS="-fuse-ld=lld -s -w"
          go build -v -tags android -trimpath -ldflags "-s -X github.com/rclone/rclone/fs.Version=${VERSION}" -o build/rclone-android-${RCLONE_NDK_VERSION}-x86 .

      - name: Build Android x64
        run: |
          export CC=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android${RCLONE_NDK_VERSION}-clang
          export CC_FOR_TARGET=$CC
          export GOOS=android
          export GOARCH=amd64
          export CGO_ENABLED=1
          export CGO_LDFLAGS="-fuse-ld=lld -s -w"
          go build -v -tags android -trimpath -ldflags "-s -X github.com/rclone/rclone/fs.Version=${VERSION}" -o build/rclone-android-${RCLONE_NDK_VERSION}-x64 .
 
      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rclone-android-all
          path: build/rclone-android-*
